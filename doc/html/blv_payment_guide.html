<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>BlueViaAndroidSDK: Payment API guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript">
$(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">BlueViaAndroidSDK&#160;<span id="projectnumber">1.4</span></div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Packages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('blv_payment_guide.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<h1>Payment API guide </h1>  </div>
</div>
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="call_abstract_sec"></a>
Abstract</h2>
<p>The Bluevia Payment API is a set of functions that enables individual, atomic payments based on input economic information. This guide represents a practical introduction to developing applications in which the user wants to provide the Bluevia Payment functionality.</p>
<h2><a class="anchor" id="blv_payment_api_making_payment_session_sec"></a>
Bluevia Payment API: Making payment sessions</h2>
<p>A payment session allows to charge a precise, economic amount, on the user's account.</p>
<h3><a class="anchor" id="payment_client_basics_sec"></a>
Payment Client Basics</h3>
<p>A Payment client represents the client side in a classic client-server schema. This object wraps up the underlying REST client side functionality needed to perform requests against a REST server. Moreover the Payment client provides a set of mock working modes useful to test its functionality even without connectivity or a real server.</p>
<p>Any Bluevia client perform requests and receive responses in a secure mode. Clients are authorized following the OAuth protocol. This security protocol enables users to grant third-party access to their resources without sharing their passwords. So clients store the authorization data -called security credentials- to grant access the server.</p>
<p>Bluevia Payment API uses an extension of OAuth protocol to guarantee secure payment operations. For each payment the user makes he must complete the OAuth process to identify itself and get a valid acess token. These tokens will be valid for 48 hours and then will be dismissed. Following sections describe what security credentials we are talking about and the modifications this API needs.</p>
<h3><a class="anchor" id="creating_a_payment_client_sec"></a>
Creating a Payment Client</h3>
<p>The first step in using the Payment client is to create a PaymentClient object. As we mentioned earlier this object could have two different working modes: i) as a client which sends requests to a real server, or ii) as a client which sends request and receives responses to/from a mock server. If the user wants to test or to run his application by using a mock client he also can decide how the server will work.</p>
<h4><a class="anchor" id="paymentclient_features_working_modes_sec"></a>
PaymentClient features: working modes</h4>
<p>When you create the client, you can specify various working modes: </p>
<ul>
<li>
<p class="startli">AbstractRestClient.Mode.LIVE <br/>
In the Live environment your application uses the real network, which means that you will be able to send real transactions to real Movistar, O2 and Vivo customers in the applicable country.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">AbstractRestClient.Mode.TEST <br/>
The Test mode behave exactly like the Live mode, but the API calls are free of chargue, using a credits system. You are required to have a Movistar, O2 or Vivo mobile number to get this monthly credits.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">AbstractRestClient.Mode.SANDBOX <br/>
The Sandbox environment offers you the exact same experience as the Live environment except that no traffic is generated on the live network, meaning you can experiment and play until your heartâ€™s content.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">AbstractRestClient.Mode.MOCK_OK <br/>
The client works against a mock Bluevia server which always serves properly any request.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">AbstractRestClient.Mode.MOCK_UNAUTHORIZED <br/>
The client works against a mock Bluevia server which always responds with an BlueviaClientException informing the user is not authorized to perform that request.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli">AbstractRestClient.Mode.MOCK_ERROR_IOEXCEPTION <br/>
The client works against a mock Bluevia server which always responds with an BlueviaClientException informing the user is unable to connect the server due to an in/out exception.</p>
<p class="endli"></p>
</li>
<li>
AbstractRestClient.Mode.MOCK_ERROR_HTTPEXCEPTION <br/>
The client works against a mock Bluevia server which always responds with a BlueviaClientException informing the user is unable to connect the server due a http exception. </li>
</ul>
<h2><a class="anchor" id="paymentclient_features_security_credentials_sec"></a>
Payment API OAuth protocol</h2>
<p>BlueVia uses OAuth as its authentication mechanism which enables websites and applications to access the BlueVia API's without end users disclosing their personal credentials. In order to grant access to the server any client has to be created passing the security credential as parameter in its constructor. These security credentials are managed internally and added as a HTTP header in every request sent to the server. Such Oauth security credentials are: </p>
<ul>
<li>
<p class="startli"><b>Consumer key</b> <br/>
The string identifying the application- you obtained when you registered your application within the provisioning portal.</p>
<p class="endli"></p>
</li>
<li>
<p class="startli"><b>Consumer Secret</b> <br/>
A secret -a string- used by the consumer to establish ownership of the consumer key.</p>
<p class="endli"></p>
</li>
<li>
<b>Access token</b> <br/>
The token -OAuth access token- used by the client for granting access permissions to the server </li>
</ul>
<h3><a class="anchor" id="retrieving_payment_request_token_sec"></a>
Step 1: retrieving a request token</h3>
<p>First, you have to retrieve a request token to be authorised by the user. In this case you have to use the PaymentRequestToken object, which includes the Payment info besides the usual request tokens params:</p>
<div class="fragment"><pre class="fragment">BlueviaPaymentClient paymentClient;
<span class="keywordflow">try</span> {
        paymentClient = <span class="keyword">new</span> BlueviaPaymentClient(getApplicationContext(), Mode.LIVE, <span class="stringliteral">&quot;consumer_key&quot;</span>, <span class="stringliteral">&quot;consumer_secret&quot;</span>);
} <span class="keywordflow">catch</span> (BlueviaClientException e){
        Log.e(TAG, e.getMessage());
}

ServiceInfo serviceInfo = <span class="keyword">new</span> ServiceInfo(<span class="stringliteral">&quot;service_id&quot;</span>, <span class="stringliteral">&quot;service_name&quot;</span>);
RequestToken requestToken = paymentClient.getRequestToken(100, <span class="stringliteral">&quot;GBP&quot;</span>, serviceInfo);
</pre></div><h3><a class="anchor" id="retrieving_payment_verification_sec"></a>
Step 2: Take the user to BlueVia Connect</h3>
<p>Take the user to BlueVia Connect to authorise the application as usual.</p>
<h3><a class="anchor" id="retrieving_payment_access_token_sec"></a>
Step 3: retrieveing an access token</h3>
<p>With the obatined oauth_verifier, you can now get the accessToken from the user as follows:</p>
<div class="fragment"><pre class="fragment">String token = requestToken.getToken();
String secret = requestToken.getSecret();
String verifier = <span class="stringliteral">&quot;000000&quot;</span>; <span class="comment">/* Get verifier from GUI */</span>
Token accessToken = paymentClient.getAccessToken(token, secret, verifier);
</pre></div><p>Note: the PaymentClient will store the access token internally to make calls to payment API using the same client. Additionally the access token is returned to to allow storing it persistentely for subsequent requests (remember the lifetime of the token is 48 hours). The are two ways in order to use a previosly obtained token: creating a BlueviaPaymentClient supplying it or using the setAccessToken function of the client.</p>
<h2><a class="anchor" id="paymentclient_features_funcitions"></a>
PaymentClient features:</h2>
<h3><a class="anchor" id="paymentclient_features_payment_function"></a>
PaymentClient features : payment function</h3>
<p>It's a once shot function. Once used for a Token, given in the client constructor, it cannot be used again. If the result status of the process of payment is a success then a transaction identifier is returned that may be used in a eventual refund process that might be necessary. Otherwise, if the result status of the payment process is a failure then none is returned and an BlueviaClientException with detailed information is thrown. This function provides the main feature of the API, the making of payments.</p>
<p>Function call sample follows : </p>
<div class="fragment"><pre class="fragment">PaymentResult result = paymentClient.payment(amount, currency);
String transactionId = result.getTransactionId();
</pre></div><p>It is possible to receive status notifications by providing BlueVia with an URI where notifications must be sent:</p>
<div class="fragment"><pre class="fragment">PaymentResult result = paymentClient.payment(amount, currency, endpoint, correlator);
</pre></div><p>Params:<br/>
 <b>amount</b> : Amount to be charged, it may be an economic amount or a number of 'virtual units' (points, tickets, etc) (mandatory). <br/>
 <b>currency</b> : Type of currency which corresponds with the amount above, following ISO 4217 (mandatory). <br/>
 <b>endpoint</b> : The endpoint to receive notifications of payments operations (optional). <br/>
 <b>correlator</b> : An string to correlate the requests and the notifications (optional). <br/>
 Return:<br/>
 <b>paymentResult</b> : A result containing the identifier assigned by the server for the transaction and other information like the status.<br/>
 Throws:<br/>
 An BlueviaClientException informs about errors encountered in the request/response.<br/>
</p>
<h4><a class="anchor" id="paymentclient_features_get_status_function"></a>
PaymentClient features : get payment status</h4>
<p>The function getPaymentStatus allows to request the status of a previous payment operation. If the refund process is unsuccessful then an BlueviaClientException with detailed information is thrown.</p>
<p>Use its transaction identifier as sole parameter.</p>
<div class="fragment"><pre class="fragment">paymentClient.getPaymentStatus(transactionId);
</pre></div><h4><a class="anchor" id="paymentclient_features_cancel_authorization_function"></a>
PaymentClient features : cancel authorization function</h4>
<p>After having requested a token you can cancel the authorization for that token before making the payment, or cancel get status requests after the payment. If the cancel authorization process is unsuccessful then an BlueviaClientException with detailed information is thrown.</p>
<div class="fragment"><pre class="fragment">paymentClient.cancelAuthorization();
</pre></div><h4><a class="anchor" id="paymentclient_features_freeing_resources_sec"></a>
PaymentClient features: freeing resources</h4>
<p>It is very important to free the resources that the client instantiates to work. To do this call the close method after finishing using the client:</p>
<div class="fragment"><pre class="fragment">paymentClient.close();
</pre></div><h4><a class="anchor" id="paymentclient_processes_code_example"></a>
Bluevia Payment API: code examples</h4>
<div class="fragment"><pre class="fragment"><span class="comment">// String to keep transaction identifier</span>
String transactionId = null;

<span class="comment">// Make a payment session</span>
<span class="comment">// 1. Create the client (you have to choose the mode and include the OAuth authorization values)  </span>
BlueviaPaymentClient paymentClient = <span class="keyword">new</span> BlueviaPaymentClient(getApplicationContext(), Mode.LIVE, <span class="stringliteral">&quot;consumer_key&quot;</span>, <span class="stringliteral">&quot;consumer_secret&quot;</span>);

<span class="comment">// 2. OAuth process</span>
RequestToken requestToken = null;
<span class="keywordflow">try</span> {
        ServiceInfo serviceInfo = <span class="keyword">new</span> ServiceInfo(<span class="stringliteral">&quot;service_id&quot;</span>, <span class="stringliteral">&quot;service_name&quot;</span>);
        RequestToken requestToken = paymentClient.getRequestToken(100, <span class="stringliteral">&quot;GBP&quot;</span>, serviceInfo);
} <span class="keywordflow">catch</span> (BlueviaClientException e) {
        Log.e(TAG, e.getMessage());
}

<span class="comment">//...</span>
<span class="comment">//...</span>

<span class="comment">// Authorization in Bluevia Connect Portal</span>
<span class="comment">// Get OAuth verifier from GUI</span>
String oauth_verifier = null;

<span class="comment">//...</span>
<span class="comment">//...</span>

<span class="keywordflow">try</span> {
        Token accessToken = paymentClient.getAccessToken(requestToken.getToken(), requestToken.getSecret(), oauth_verifier);

} <span class="keywordflow">catch</span> (BlueviaClientException e) {
        Log.e(TAG, e.getMessage());
}

<span class="comment">// 3. Make the payment</span>
<span class="keywordflow">try</span> {
        <span class="comment">// Specify the payment information</span>
        <span class="comment">// Make the payment session</span>
        PaymentResult result = paymentClient.payment(100, <span class="stringliteral">&quot;GBP&quot;</span>);
        Log.d(TAG, <span class="stringliteral">&quot;Successful payment with transaction identifier: &quot;</span> + transactionId);
} <span class="keywordflow">catch</span> (BlueviaClientException e) {
        Log.e (TAG,<span class="stringliteral">&quot;Unsuccessful payment session :&quot;</span>, e);
}

<span class="comment">// 4. Get Payment status</span>

<span class="keywordflow">try</span> {
        PaymentStatus status = paymentClient.getPaymentStatus(result.getTransactionId());
        Log.d(TAG, <span class="stringliteral">&quot;Payment status &quot;</span> + status.getTransactionStatus());          
} <span class="keywordflow">catch</span> ( BlueviaClientException e) {
        Log.e (TAG, <span class="stringliteral">&quot;Error getting status :&quot;</span>, e);
}

<span class="comment">// 5. close the client</span>
paymentClient.close();
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="footer">Generated on Thu Jan 26 2012 11:10:33 for BlueViaAndroidSDK by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </li>
    </ul>
  </div>

</body>
</html>
